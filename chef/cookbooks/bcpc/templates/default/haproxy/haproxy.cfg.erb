###############################################################################
#                             generated by chef
###############################################################################

global
  daemon
  user haproxy
  group haproxy
  pidfile /var/run/haproxy.pid
  stats socket /var/run/haproxy/haproxy.asok user root group haproxy mode 775 level admin
  log /dev/log local0 info alert
  maxconn 8000

defaults
  log global
  mode http
  option http-server-close
  option abortonclose
  option tcplog
  option dontlognull
  option redispatch
  retries 3
<% if node['bcpc']['haproxy']['qos']['enabled'] %>
  timeout http-request <%= node['bcpc']['haproxy']['qos']['http_request_timeout'] %>
<% else %>
  timeout http-request 10s
<% end %>
  timeout queue 1m
  timeout connect 5s
  timeout check 10s
  timeout client 30m
  timeout server 30m

frontend http
  bind <%= @vip %>:80
  option httplog
  default_backend http-backend

frontend https
  bind <%= @vip %>:443 ssl crt /etc/haproxy/haproxy.pem
  option httplog
  stats enable
  stats uri /haproxy
  stats hide-version
  stats realm Haproxy\ Statistics
  stats auth <%= @user['username'] %>:<%= @user['password'] %>
  http-request add-header X-Forwarded-Proto https if { ssl_fc }
  acl url_horizon path_beg /horizon
  use_backend horizon-backend if url_horizon
  acl url_horizon_static path_beg /static
  use_backend horizon-backend if url_horizon_static
  acl url_rabbitmq path_beg /rabbitmq
  use_backend rabbitmq-web-backend if url_rabbitmq
  default_backend http-backend

backend http-backend
  balance source
  option httpchk GET /
  http-check expect status 200
<% @headnodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['service_ip'] %>:80 check inter 5s rise 1 fall 1
<% end -%>

backend horizon-backend
  balance source
  option httpchk GET /
  option forwardfor
  http-check expect status 200
<% @headnodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['service_ip'] %>:9999 check inter 5s rise 1 fall 1
<% end -%>

backend rabbitmq-web-backend
  balance source
  option httpchk GET /
  http-check expect status 200
  http-request set-uri %[url,regsub(^/rabbitmq/?,/,)] if { path_beg /rabbitmq }
<% @rmqnodes.each do |n| -%>
  server <%= n['hostname'] %> <%= n['service_ip'] %>:55672 check inter 5s rise 1 fall 1
<% end -%>

peers headnodes
<% @headnodes.each do |n| -%>
  peer <%= n['hostname'] %> <%= n['service_ip'] %>:32768
<% end -%>

backend stick-table-qos
  stick-table type ip size <%= node['bcpc']['haproxy']['qos']['max_entries'] %> expire <%= node['bcpc']['haproxy']['qos']['entry_expiration'] %> peers headnodes store conn_cur,conn_rate(<%= node['bcpc']['haproxy']['qos']['conn_rate_period'] %>),http_req_rate(<%= node['bcpc']['haproxy']['qos']['http_req_rate_period'] %>),http_err_rate(<%= node['bcpc']['haproxy']['qos']['http_err_rate_period'] %>)
