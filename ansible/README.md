
# Ansible

[Ansible](https://docs.ansible.com/ansible/latest/index.html) automation is
used to prepare the machines specified in an inventory file for the
installation of the various OpenStack services by Chef. This includes:
- Setting up networking (network interfaces, service IPs, BGP, proxies)
- Setting up users, SSH access, Chrony, update /etc/hosts, configure apt
    sources, etc.
- Installing and setting up Chef

Once the above has been performed the Chef client can be run and the various
OpenStack services installed. Afterwards, Ansible is used to perform various
post-installation tasks like:
- Reweight Ceph OSD nodes
- Add cloud images
- Register compute nodes
- Enable compute services
- Configure host aggregates

# Directory Structure and Contents

## inventory.yml

The Ansible inventory file defines the machines that are to be configured into
a cluster. Each machine, or node, belongs to a given group (i.e. bootstraps,
headnodes, etc.), and each group is handled by its own [playbook](#playbooks).
In addition, each node also defines a list of Chef roles that apply to it and
which are executed when `chef-client` is run.

When running chef-bcpc locally the inventory file is generated by
[this](../virtual/bin/create-virtual-environment.sh) script.

## group_vars/all

This directory contains overrides for Ansible and Chef defaults.

- [overrides.yml.example](group_vars/all/overrides.yml.example) describes how
to override various
[default settings](playbooks/roles/common/defaults/main/base.yml) defined for
the *common* Ansible role.
- [chef_environment.yml.example](group_vars/all/chef_environment.yml.example)
describes how to override the section *chef_environment* in
[chef.yml](playbooks/roles/common/defaults/main/chef.yml) and Chef attribute
defaults specified [here](../chef/cookbooks/bcpc/attributes/).

The Chef data bag containing the various usernames, keys and certificates each
service is configured with can be generated using the *generate-chef-databags*
[Makefile](../Makefile) target and placed here.

## playbooks

This directory defines various Ansible playbooks and their corresponding roles.
Each node specified in the Ansible inventory file is handled by a specific
playbook, depending on what subgroup it is defined in (bootstraps, headnodes,
etc.) Each playbook declares the roles that apply to it, and each [role](#roles)
defines the tasks and tags associated with it.

### roles

This directory defines the various roles Ansible uses to accomplish its goal.
Each role defines the tasks associated with it, default attribute values, and
file and templates to install on the target node. A task may have one or more
tags, allowing users to easily execute groups of tasks.
